<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Snow Cam</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Snow Cam">
  <meta name="theme-color" content="#000000">
  <style>
    html,body {margin:0;height:100%;background:#000;overflow:hidden;}
    #wrap {position:fixed;inset:0;}
    video,canvas {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}

    /* –ö–Ω–æ–ø–∫–∏ ‚Äî –ª–∞–∫–æ–Ω–∏—á–Ω–æ */
    #start, #shotBtn {
      position:fixed; left:1rem; right:1rem;
      padding:.9rem 1.1rem; font:600 16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      border-radius:.75rem; border:0; background:#fff;
    }
    #start { bottom:1.6rem; }
    #shotBtn { bottom:5rem; display:none; }

    /* –õ–∞–∫–æ–Ω–∏—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≤–µ—Ä—Ö—É */
    #brand {
      position:fixed; top:.8rem; left:50%; transform:translateX(-50%);
      font:600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff; letter-spacing:.5px;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      z-index:6; user-select:none; pointer-events:none;
      opacity:.9;
    }

    /* –°–Ω–µ–≥–æ–≤–∏–∫ (GIF) ‚Äî –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ pinch-zoom */
    #mascot {
      position:absolute; left:1rem; bottom:5rem;
      width:24%; max-width:280px; z-index:5; display:none;
      touch-action:none; user-select:none; cursor:grab;
      --tx:0px; --ty:0px; --s:1;
      transform:translate(var(--tx),var(--ty)) scale(var(--s));
      transform-origin:center center;
    }
    #mascot.dragging { cursor:grabbing; }
    #mascot img { display:block; width:100%; height:auto; pointer-events:none; }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <!-- –°–Ω–µ–≥–æ–≤–∏–∫ (GIF). –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –≤ assets/snowman.gif -->
    <div id="mascot"><img id="mascotImg" src="assets/snowman.gif" alt="Snowman" draggable="false"></div>
  </div>

  <div id="brand">christmas-spb.ru</div>
  <button id="shotBtn">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
  <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>

  <script>
    const startBtn = document.getElementById('start');
    const shotBtn  = document.getElementById('shotBtn');
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('canvas');
    const ctx      = canvas.getContext('2d', { alpha: true });
    const mascot   = document.getElementById('mascot');
    const mascotImg= document.getElementById('mascotImg');

    // ---- –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ "—Å–Ω–µ–∂–∏–Ω–∫–∏": –º–µ–Ω—å—à–µ –∏ –º–µ–Ω–µ–µ –ø—É—à–∏—Å—Ç—ã–µ ----
    let flakes = [], sprites = [], running = false;

    function makeFlakeSprite(size){
      const s = Math.max(10, size|0);
      const off = document.createElement('canvas');
      off.width = off.height = s;
      const c = off.getContext('2d');
      // —Ä–∞–¥–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å –∫–æ—Ä–æ—Ç–∫–∏–º –º—è–≥–∫–∏–º –∫—Ä–∞–µ–º (–º–µ–Ω–µ–µ ¬´–ø—É—à–∏—Å—Ç—ã–π¬ª)
      const g = c.createRadialGradient(s/2, s/2, s*0.05, s/2, s/2, s*0.42);
      g.addColorStop(0.0, 'rgba(255,255,255,0.95)');
      g.addColorStop(0.6, 'rgba(255,255,255,0.35)');
      g.addColorStop(1.0, 'rgba(255,255,255,0.00)');
      c.fillStyle = g;
      c.beginPath(); c.arc(s/2, s/2, s*0.42, 0, Math.PI*2); c.fill();
      return off;
    }
    function buildSprites(){
      sprites = [ makeFlakeSprite(16), makeFlakeSprite(14), makeFlakeSprite(12) ];
    }

    function resize() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.width  = Math.floor(canvas.clientWidth  * dpr);
      canvas.height = Math.floor(canvas.clientHeight * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resize);

    function initSnow() {
      const area = canvas.clientWidth * canvas.clientHeight;
      const n = Math.max(70, Math.floor(area / 26000)); // —É–º–µ—Ä–µ–Ω–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å
      flakes = new Array(n).fill(0).map(() => ({
        x0: Math.random() * canvas.clientWidth,
        y:  Math.random() * canvas.clientHeight,
        r:  6 + Math.random()*6,             // –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        vy: 0.7 + Math.random()*1.0,         // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
        swayAmp: 6 + Math.random()*10,       // –Ω–µ–±–æ–ª—å—à–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ
        theta: Math.random()*Math.PI*2,
        swaySpeed: 0.012 + Math.random()*0.018,
        sprite: sprites[(Math.random()*sprites.length)|0]
      }));
    }

    function drawSnow(targetCtx) {
      for (const f of flakes) {
        f.theta += f.swaySpeed;
        const x = f.x0 + Math.sin(f.theta) * f.swayAmp;
        f.y += f.vy;
        if (f.y - f.r > canvas.clientHeight + 8) {
          f.y = -f.r - Math.random()*40;
          f.x0 = Math.random()*canvas.clientWidth;
          f.theta = Math.random()*Math.PI*2;
        }
        const s = f.sprite, size = f.r * 2;
        targetCtx.drawImage(s, x - f.r, f.y - f.r, size, size);
      }
    }

    function drawTitle(targetCtx){
      const w = canvas.clientWidth;
      targetCtx.save();
      targetCtx.font = '600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif';
      targetCtx.textAlign = 'center';
      targetCtx.textBaseline = 'top';
      targetCtx.fillStyle = 'rgba(255,255,255,0.92)';
      targetCtx.shadowColor = 'rgba(0,0,0,0.45)';
      targetCtx.shadowBlur = 6;
      targetCtx.fillText('christmas-spb.ru', w/2, 10);
      targetCtx.restore();
    }

    function renderFrame(targetCtx){
      // –≤–∏–¥–µ–æ
      try { targetCtx.drawImage(video, 0, 0, canvas.clientWidth, canvas.clientHeight); } catch(e) {}
      // –ª—ë–≥–∫–∞—è –≤—É–∞–ª—å ‚Äî –µ—â—ë —Ç–æ–Ω—å—à–µ
      targetCtx.fillStyle = 'rgba(255,255,255,0.015)';
      targetCtx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      // —Å–Ω–µ–≥
      drawSnow(targetCtx);
      // —Ç–∏—Ç—É–ª
      drawTitle(targetCtx);
      // —Å–Ω–µ–≥–æ–≤–∏–∫ ‚Äî –ø–æ–≤–µ—Ä—Ö
      const rC = canvas.getBoundingClientRect();
      const rM = mascot.getBoundingClientRect();
      const scale = canvas.width / rC.width;
      const mx = (rM.left - rC.left) * scale;
      const my = (rM.top  - rC.top ) * scale;
      const mw = rM.width * scale;
      const mh = rM.height * scale;
      if (mascotImg.complete) {
        try { targetCtx.drawImage(mascotImg, mx, my, mw, mh); } catch(e){}
      }
    }

    function draw(){
      if (!running) return;
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      renderFrame(ctx);
      requestAnimationFrame(draw);
    }

    async function start(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode:{ ideal:'environment' }, width:{ ideal:1280 }, height:{ ideal:720 } },
          audio:false
        });
        video.srcObject = stream;
        await video.play();

        resize(); buildSprites(); initSnow();
        running = true;
        startBtn.remove();
        shotBtn.style.display = 'block';
        mascot.style.display  = 'block';

        requestAnimationFrame(draw);
      } catch(e){
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: ' + e.message);
      }
    }
    startBtn.addEventListener('click', start);

    // ---- –°–Ω–∏–º–æ–∫ –∫–∞–¥—Ä–∞ ----
    shotBtn.addEventListener('click', ()=>{
      const shot = document.createElement('canvas');
      shot.width = canvas.width; shot.height = canvas.height;
      const sctx = shot.getContext('2d');
      renderFrame(sctx);
      const url = shot.toDataURL('image/png');
      const a = document.createElement('a');
      const ts = new Date(), p=n=>String(n).padStart(2,'0');
      a.download = `christmas-spb_${ts.getFullYear()}-${p(ts.getMonth()+1)}-${p(ts.getDate())}_${p(ts.getHours())}-${p(ts.getMinutes())}-${p(ts.getSeconds())}.png`;
      a.href = url;
      if (/iphone|ipad|ipod/i.test(navigator.userAgent)) window.open(url,'_blank'); else a.click();
    });

    // ---- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ/–º–∞—Å—à—Ç–∞–± ----
    const pointers = new Map();
    let dragId=null, dragStartX=0, dragStartY=0, startTx=0, startTy=0, startScale=1, startDist=0;

    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
    function getTransform(){
      const st = getComputedStyle(mascot);
      return {
        tx: parseFloat(st.getPropertyValue('--tx'))||0,
        ty: parseFloat(st.getPropertyValue('--ty'))||0,
        s:  parseFloat(st.getPropertyValue('--s')) ||1
      };
    }
    function setTransform(tx,ty,s){
      mascot.style.setProperty('--tx', tx+'px');
      mascot.style.setProperty('--ty', ty+'px');
      mascot.style.setProperty('--s',  s);
    }

    mascot.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      mascot.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      const n = pointers.size;
      const {tx,ty,s} = getTransform();
      if(n===1){
        dragId=e.pointerId; dragStartX=e.clientX; dragStartY=e.clientY; startTx=tx; startTy=ty; mascot.classList.add('dragging');
      }else if(n===2){
        startScale=s; const [p1,p2]=Array.from(pointers.values()); startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1; mascot.classList.remove('dragging'); dragId=null;
      }
    },{passive:false});

    mascot.addEventListener('pointermove', (e)=>{
      if(!pointers.has(e.pointerId)) return;
      e.preventDefault();
      pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      const n = pointers.size; const {tx,ty,s}=getTransform();
      if(n===1 && dragId!==null){
        const cur=pointers.get(dragId); const dx=cur.x-dragStartX; const dy=cur.y-dragStartY; setTransform(startTx+dx,startTy+dy,s);
      }else if(n===2){
        const [p1,p2]=Array.from(pointers.values()); const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1; const scale=clamp(startScale*(dist/startDist),0.3,3); setTransform(tx,ty,scale);
      }
    },{passive:false});

    function endPointer(e){
      if(pointers.has(e.pointerId)) pointers.delete(e.pointerId);
      if(e.pointerId===dragId){ dragId=null; mascot.classList.remove('dragging'); }
      if(pointers.size===1){
        const id=Array.from(pointers.keys())[0], pt=pointers.get(id), {tx,ty}=getTransform();
        dragId=id; dragStartX=pt.x; dragStartY=pt.y; startTx=tx; startTy=ty; mascot.classList.add('dragging');
      }
    }
    mascot.addEventListener('pointerup', endPointer, {passive:false});
    mascot.addEventListener('pointercancel', endPointer, {passive:false});
    mascot.addEventListener('pointerleave', endPointer, {passive:false});
  </script>
</body>
</html>
