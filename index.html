<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Snow Cam</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Snow Cam">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --fab-size:56px; --fab-gap:.6rem;
      --glass-bg:rgba(255,255,255,.12); --glass-brd:rgba(255,255,255,.28); --glass-on:rgba(255,255,255,.22);
      /* высота «земли», над которой копятся сугробы */
      --ground-offset: 88px;
    }

    html,body{margin:0;height:100%;background:#000;overflow:hidden;}
    #wrap{position:fixed;inset:0}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    video{z-index:1}
    canvas{z-index:2}
    *{-webkit-tap-highlight-color:transparent}

    /* маскот (снеговик gif) */
    #mascot{
      position:absolute; left:1rem; bottom:4.8rem; z-index:5; display:none;
      width:38%; max-width:430px; touch-action:none; user-select:none; cursor:grab;
      --tx:0px; --ty:0px; --s:1; transform:translate(var(--tx),var(--ty)) scale(var(--s)); transform-origin:center center;
    }
    #mascot.dragging{cursor:grabbing;}
    #mascot img{display:block;width:100%;height:auto;pointer-events:none}

    /* бренд и панель (скрыты до старта) */
    #brand{
      position:fixed; top:.8rem; left:50%; transform:translateX(-50%);
      font:600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff; letter-spacing:.5px; opacity:.9; text-shadow:0 1px 2px rgba(0,0,0,.6);
      z-index:6; user-select:none; pointer-events:none; display:none;
    }
    #controls{position:fixed; bottom:.9rem; z-index:7; left:50%; transform:translateX(-50%); gap:var(--fab-gap); display:none;}

    /* кнопки */
    .fab{
      position:relative; width:var(--fab-size); height:var(--fab-size); border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background:var(--glass-bg); border:1px solid var(--glass-brd); backdrop-filter:blur(10px);
      color:rgba(255,255,255,.78);
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      outline:none; cursor:pointer;
      transition:transform .12s ease, background .15s ease, color .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .fab svg{width:26px;height:26px;stroke:currentColor;fill:none;stroke-width:2;vector-effect:non-scaling-stroke;stroke-linecap:round;stroke-linejoin:round}
    .fab:active{transform:scale(.96)}
    .fab.is-on{background:var(--glass-on); color:#fff; box-shadow:0 8px 22px rgba(0,0,0,.45), 0 0 0 2px rgba(255,255,255,.12) inset}
    .fab:hover{filter:brightness(1.08)}
    .fab:focus-visible{outline:2px solid rgba(255,255,255,.6); outline-offset:2px}
    #shotBtn{border:1px solid rgba(255,255,255,.35); color:#fff; background:linear-gradient(to bottom,rgba(255,255,255,.18),rgba(255,255,255,.10))}

    /* вспышка и старт */
    #flash{position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none; z-index:8; transition:opacity .45s ease}
    #flash.go{opacity:.9}
    #start{position:fixed; left:1rem; right:1rem; bottom:1.2rem; z-index:7; padding:.9rem 1.1rem;
      font:600 16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; border-radius:.75rem; border:0; background:#fff; cursor:pointer}

    @media (max-width:380px){ :root{ --ground-offset:76px; } }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
    <div id="mascot"><img id="mascotImg" src="assets/snowman.gif" alt="Snowman" draggable="false"></div>
  </div>

  <div id="flash"></div>
  <div id="brand">christmas-spb.ru</div>

  <div id="controls" aria-label="Управление">
    <button id="btnSnow" class="fab is-on" type="button" aria-pressed="true" title="Снег">
      <svg viewBox="0 0 24 24"><path d="M12 2v20M12 12L21 7M12 12L3 7M12 12l9 5M12 12L3 17M2 12h20M7 4l3 1.8M17 4l-3 1.8M7 20l3-1.8M17 20l-3-1.8"/></svg>
    </button>
    <button id="btnMascot" class="fab is-on" type="button" aria-pressed="true" title="Снеговик">
      <svg viewBox="0 0 24 24"><g transform="translate(0.5 0.5)"><circle cx="12" cy="15.5" r="5"/><circle cx="12" cy="8" r="3.2"/><path d="M6.2 12.5L4 11M17.8 12.5L20 11"/><path d="M9.4 6.6h5.2M9 6l6-.6"/></g></svg>
    </button>
    <button id="btnMusic" class="fab is-on" type="button" aria-pressed="true" title="Музыка">
      <svg viewBox="0 0 24 24"><path d="M9 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M9 12V5l10-2v7"/></svg>
    </button>
    <button id="btnPlow" class="fab is-on" type="button" aria-pressed="true" title="Автопроезд плуга (20с)">
      <svg viewBox="0 0 24 24"><path d="M3 14h9l3-3h3l3 5v3H3z"/><circle cx="8" cy="19" r="2.2"/><circle cx="18" cy="19" r="2.2"/></svg>
    </button>
    <button id="shotBtn" class="fab" type="button" title="Сделать фото">
      <svg viewBox="0 0 24 24"><path d="M4 8h3l1.6-2.2c.2-.3.5-.5.9-.5h4.9c.4 0 .7.2.9.5L17 8h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z"/><circle cx="12" cy="14" r="3.2"/></svg>
    </button>
  </div>

  <!-- единственное, что видно до старта -->
  <button id="start">Запустить камеру</button>

<script>
'use strict';
/* ------------ refs ------------ */
const startBtn=document.getElementById('start');
const shotBtn =document.getElementById('shotBtn');
const btnSnow =document.getElementById('btnSnow');
const btnMascot=document.getElementById('btnMascot');
const btnMusic=document.getElementById('btnMusic');
const btnPlow =document.getElementById('btnPlow');
const controls=document.getElementById('controls');
const flash   =document.getElementById('flash');
const brand   =document.getElementById('brand');
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d',{alpha:true});
const mascot=document.getElementById('mascot');
const mascotImg=document.getElementById('mascotImg');

const DPR=Math.min(window.devicePixelRatio||1,2);
const CAPTURE_DPR=DPR;

/* ------------ state ------------ */
let running=false, snowEnabled=true, mascotEnabled=true, musicEnabled=true;

/* ------------ музыка ------------ */
let bgm=null, audioCtx=null, gain=null;
function initAudio(){ if(bgm) return; bgm=new Audio(); bgm.loop=true; bgm.preload='auto'; bgm.src='assets/song.mp3';
  const AC=window.AudioContext||window.webkitAudioContext;
  if(AC){ audioCtx=new AC(); const src=audioCtx.createMediaElementSource(bgm); gain=audioCtx.createGain(); gain.gain.value=0.0; src.connect(gain).connect(audioCtx.destination); }
  else bgm.volume=0.0;
}
async function startMusic(){ try{ initAudio(); if(audioCtx&&audioCtx.state==='suspended') await audioCtx.resume(); await bgm.play(); fadeTo(0.6,0.5);}catch(e){ musicEnabled=false; updateTogglesUI(); } }
function stopMusic(){ fadeTo(0.0,0.4); setTimeout(()=>{try{bgm.pause();}catch(_){}} ,420); }
function fadeTo(target,dur){ if(gain&&audioCtx){ const now=audioCtx.currentTime; gain.gain.cancelScheduledValues(now); gain.gain.setValueAtTime(gain.gain.value,now); gain.gain.linearRampToValueAtTime(target, now+dur); }
  else if(bgm){ const from=bgm.volume, steps=Math.max(1,Math.floor(dur*30)); let i=0; const t=setInterval(()=>{ i++; bgm.volume=from+(target-from)*i/steps; if(i>=steps) clearInterval(t); },33);} }

/* ===== утилита: скруглённый прямоугольник (вместо ctx.roundRect) ===== */
function roundRectPath(ctx,x,y,w,h,r=6){
  const rr = Math.min(r, Math.abs(w)/2, Math.abs(h)/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.lineTo(x+w-rr, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+rr);
  ctx.lineTo(x+w, y+h-rr);
  ctx.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
  ctx.lineTo(x+rr, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-rr);
  ctx.lineTo(x, y+rr);
  ctx.quadraticCurveTo(x, y, x+rr, y);
}

/* ========== СНЕГ В CANVAS ========== */
let flakes=[], sprites=[], heightmap=[], binW=4, bins=0, groundY=0;
const spray=[]; // частицы разлёта
let nextPlowTimer=null; // одна декларация таймера

function cssPx(varName, fallback){
  const v=getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  const m=/(-?\d+(\.\d+)?)px/.exec(v); return m?parseFloat(m[1]):fallback;
}
function makeFlakeSprite(size){
  const s=Math.max(10,size|0);
  const off=document.createElement('canvas'); off.width=off.height=s;
  const c=off.getContext('2d');
  const g=c.createRadialGradient(s/2,s/2,s*0.05,s/2,s/2,s*0.48);
  g.addColorStop(0,'rgba(255,255,255,.98)');
  g.addColorStop(.6,'rgba(255,255,255,.45)');
  g.addColorStop(1,'rgba(255,255,255,0)');
  c.fillStyle=g; c.beginPath(); c.arc(s/2,s/2,s*0.48,0,Math.PI*2); c.fill();
  return off;
}
function buildSprites(){ sprites=[16,14,12,10].map(makeFlakeSprite); }

function initField(){
  const H=canvas.clientHeight;
  const offset = cssPx('--ground-offset', 88);
  groundY = H - offset;
  binW = 4; bins = Math.ceil(canvas.clientWidth/binW);
  heightmap = new Array(bins).fill(0);
}

function spawnFlakes(){
  const area=canvas.clientWidth*canvas.clientHeight;
  const n = Math.max(140, Math.min(360, Math.floor(area/8000)));
  const H=canvas.clientHeight;
  flakes = new Array(n).fill(0).map(()=>({
    x: Math.random()*canvas.clientWidth,
    y: -Math.random()*H,
    r: 1.5 + Math.random()*2.8,
    vy: 90 + Math.random()*120,
    swayA: 30 + Math.random()*35,
    theta: Math.random()*Math.PI*2,
    swaySpeed: 1.2 + Math.random()*1.6,
    sprite: sprites[(Math.random()*sprites.length)|0]
  }));
}

function fieldYAt(x){
  const idx = Math.max(0, Math.min(bins-1, Math.floor(x/binW)));
  const x0 = idx*binW, x1 = Math.min((idx+1)*binW, bins*binW);
  const h0 = heightmap[idx]||0, h1 = heightmap[Math.min(idx+1,bins-1)]||0;
  const t = (x - x0)/Math.max(1,(x1-x0));
  const h = h0*(1-t)+h1*t;
  return groundY - h;
}
function addSnowAt(x, amount){
  const idx = Math.max(0, Math.min(bins-1, Math.floor(x/binW)));
  const spread = 2;
  for(let k=-spread;k<=spread;k++){
    const i = idx + k; if(i<0||i>=bins) continue;
    const w = 1 - Math.abs(k)/(spread+1);
    heightmap[i] = Math.min(groundY, heightmap[i] + amount*w);
  }
}

function updateSnow(dt){
  if(!snowEnabled) return;

  for(const f of flakes){
    f.theta += f.swaySpeed * dt;
    const vx = Math.sin(f.theta) * f.swayA;
    f.y += f.vy * dt;
    f.x += vx * dt;

    if(f.x < -8) f.x = canvas.clientWidth+8;
    if(f.x > canvas.clientWidth+8) f.x = -8;

    const yTop = fieldYAt(f.x);
    if(f.y + f.r >= yTop){
      addSnowAt(f.x, 4.0 + f.r*2.2);
      f.x = Math.random()*canvas.clientWidth;
      f.y = -10 - Math.random()*canvas.clientHeight*0.4;
      f.theta = Math.random()*Math.PI*2;
    }
  }

  // частицы «спрея» (визуальные) — БЕЗ накопления сугробов
  for(let i=spray.length-1;i>=0;i--){
    const p=spray[i];
    p.vy += 1200*dt;
    p.x  += p.vx*dt; p.y += p.vy*dt;
    p.life -= dt;
    // раньше тут было addSnowAt(...) — убрал, чтобы брызги не создавали валы
    if(p.life<=0 || p.y >= fieldYAt(p.x)) spray.splice(i,1);
  }

  // лёгкое сглаживание сугробов
  for(let i=1;i<bins-1;i++){
    const avg = (heightmap[i-1]+heightmap[i]+heightmap[i+1])/3;
    heightmap[i] = heightmap[i]*0.97 + avg*0.03;
  }
}

/* ---- раздельный рендер: сугробы / плуг / снежинки ---- */
function drawDrifts(targetCtx){
  if(!snowEnabled) return;
  const W=canvas.clientWidth, H=canvas.clientHeight;
  targetCtx.save();
  const grad = targetCtx.createLinearGradient(0, groundY-80, 0, groundY+10);
  grad.addColorStop(0,'rgba(255,255,255,0.98)');
  grad.addColorStop(1,'rgba(255,255,255,0.86)');
  targetCtx.fillStyle=grad;

  targetCtx.beginPath();
  targetCtx.moveTo(0,H);
  targetCtx.lineTo(0, groundY - (heightmap[0]||0));
  for(let i=1;i<bins;i++){
    const x=i*binW;
    const y=groundY - (heightmap[i]||0);
    targetCtx.lineTo(x, y);
  }
  targetCtx.lineTo(W, H);
  targetCtx.closePath();
  targetCtx.fill();
  targetCtx.restore();
}
function drawFlakes(targetCtx){
  if(!snowEnabled) return;
  for(const f of flakes){
    const s=f.sprite, size=f.r*2;
    targetCtx.drawImage(s, f.x - f.r, f.y - f.r, size, size);
  }
}
function drawSpray(targetCtx){
  for(const p of spray){
    targetCtx.globalAlpha = Math.max(0, p.life/p.maxLife);
    targetCtx.beginPath();
    targetCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    targetCtx.fillStyle='white';
    targetCtx.fill();
  }
  targetCtx.globalAlpha = 1;
}

/* ========== НОВОГОДНИЙ ПЛУГ ========== */
const plow = {
  active:false, auto:true,
  x:-220, dir:1, speed: 280, // px/сек
  width: 180, height: 62,
  blade: 130,
  lightsN: 9
};

function scheduleNextPlow(delayMs=20000){
  clearTimeout(nextPlowTimer);
  nextPlowTimer = setTimeout(()=>{ startPlowPass(); }, delayMs);
}
function startPlowPass(){
  if(plow.active || !running) return;
  plow.active = true;
  plow.dir = 1;
  plow.x = -plow.width - 80;
}
function updatePlow(dt){
  if(!plow.active) return;
  plow.x += plow.speed * dt * plow.dir;

  // зона чистки
  const center = plow.x + plow.width*0.6;
  const w = plow.blade;
  const i0 = Math.max(0, Math.floor((center - w/2)/binW));
  const i1 = Math.min(bins-1, Math.floor((center + w/2)/binW));

  // ЧИСТКА БЕЗ «ВАЛОВ»: просто срезаем до нуля (плоско)
  for(let i=i0;i<=i1;i++){
    const h = heightmap[i]||0;
    if(h>0){
      const take = Math.min(10.0, h); // достаточно, чтобы быстро вычистить
      heightmap[i] = Math.max(0, h - take);
      // брызги — только визуально
      for(let s=0;s<2;s++){
        spray.push({
          x: i*binW + Math.random()*binW,
          y: fieldYAt(i*binW) - 6 - Math.random()*8,
          vx: (220+Math.random()*120)*plow.dir,
          vy: -(240+Math.random()*150),
          r: 1.0 + Math.random()*1.6,
          life: 0.45 + Math.random()*0.55,
          maxLife: 1.0
        });
      }
    }
  }

  if(plow.x > canvas.clientWidth + 80){
    plow.active = false;
    scheduleNextPlow(20000);
  }
}

/* красивый плуг */
function drawPlow(targetCtx, t){
  if(!plow.active) return;
  const y = groundY - 6;
  targetCtx.save();
  targetCtx.translate(plow.x, y);

  // Тень
  targetCtx.fillStyle='rgba(0,0,0,0.25)';
  targetCtx.beginPath();
  targetCtx.ellipse(180*0.35, 6, 180*0.38, 10, 0, 0, Math.PI*2);
  targetCtx.fill();

  // Корпус (градиент)
  const grd = targetCtx.createLinearGradient(0, -62, 0, 0);
  grd.addColorStop(0, '#ff4d4d');
  grd.addColorStop(1, '#b31212');
  targetCtx.fillStyle = grd;
  targetCtx.strokeStyle = 'rgba(255,255,255,0.25)';
  targetCtx.lineWidth = 2;

  // база
  roundRectPath(targetCtx, 0, -62, 180*0.62, 52, 8);
  targetCtx.fill(); targetCtx.stroke();

  // кабина
  roundRectPath(targetCtx, 180*0.44, -62*1.26, 180*0.36, 62*0.9, 8);
  targetCtx.fill(); targetCtx.stroke();

  // окно
  targetCtx.fillStyle='rgba(255,255,255,0.7)';
  roundRectPath(targetCtx, 180*0.48, -62*1.18, 180*0.26, 62*0.52, 6);
  targetCtx.fill();

  // отвал «леденец» с полосками
  targetCtx.save();
  targetCtx.translate(180*0.62, -62*0.12);
  targetCtx.fillStyle='#ffd200';
  targetCtx.beginPath();
  targetCtx.moveTo(0, 0);
  targetCtx.lineTo(130, -62*0.55);
  targetCtx.lineTo(130, 10);
  targetCtx.closePath();
  targetCtx.fill();

  targetCtx.strokeStyle='rgba(255,0,0,0.55)';
  targetCtx.lineWidth=6;
  for(let x=8; x<130; x+=16){
    targetCtx.beginPath();
    targetCtx.moveTo(x, -62*0.5);
    targetCtx.lineTo(x, 6);
    targetCtx.stroke();
  }
  targetCtx.restore();

  // гусеницы
  targetCtx.fillStyle='#222';
  roundRectPath(targetCtx, 180*0.06, -10, 180*0.52, 12, 6);
  targetCtx.fill();
  for(let i=0;i<4;i++){
    targetCtx.beginPath();
    targetCtx.arc(180*(0.12+0.1*i), -4, 6, 0, Math.PI*2);
    targetCtx.fill();
  }

  // гирлянда
  const L = 9;
  for(let i=0;i<L;i++){
    const lx = 180*0.46 + (i/(L-1))*180*0.28;
    const ly = -62*1.28 - 6 + Math.sin((i/2)+t*0.006)*2;
    const phase = (i%2===0?0:Math.PI);
    const k = 0.6 + 0.4*Math.max(0,Math.sin(t*0.008 + phase));
    targetCtx.fillStyle = `rgba(${Math.round(255*k)}, ${Math.round(80+140*k)}, ${Math.round(80)}, 0.95)`;
    targetCtx.beginPath(); targetCtx.arc(lx, ly, 3, 0, Math.PI*2); targetCtx.fill();
  }

  // «шапка Санты»
  targetCtx.fillStyle='#e53935';
  targetCtx.beginPath();
  targetCtx.moveTo(180*0.56, -62*1.30);
  targetCtx.lineTo(180*0.68, -62*1.58);
  targetCtx.lineTo(180*0.74, -62*1.30);
  targetCtx.closePath(); targetCtx.fill();
  targetCtx.fillStyle='#fff';
  targetCtx.beginPath(); targetCtx.arc(180*0.68, -62*1.58, 4, 0, Math.PI*2); targetCtx.fill();
  targetCtx.fillRect(180*0.56, -62*1.30, 180*0.18, 4);

  // пар
  for(let i=0;i<4;i++){
    const px = 180*0.02 + i*8;
    const py = -62 + 8 - i*6 + Math.sin((t+i*120)*0.01)*2;
    targetCtx.fillStyle='rgba(255,255,255,0.25)';
    targetCtx.beginPath(); targetCtx.arc(px, py, 3, 0, Math.PI*2); targetCtx.fill();
  }

  targetCtx.restore();
}

/* ------------ рендер цикла ------------ */
function resize(){
  canvas.width=Math.floor(canvas.clientWidth*DPR);
  canvas.height=Math.floor(canvas.clientHeight*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  initField();
}
window.addEventListener('resize', resize);

function renderVideo(targetCtx){
  try{ targetCtx.drawImage(video,0,0,canvas.clientWidth,canvas.clientHeight);}catch(_){}
  targetCtx.fillStyle='rgba(255,255,255,.015)'; targetCtx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
}

let lastT=performance.now();
function loop(t){
  if(!running) return;
  const dt=Math.min(0.05, (t-lastT)/1000); lastT=t;

  updateSnow(dt);
  updatePlow(dt);

  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  renderVideo(ctx);

  // порядок: сугробы → плуг → спрей → снежинки
  drawDrifts(ctx);
  drawPlow(ctx, t);
  drawSpray(ctx);
  drawFlakes(ctx);

  requestAnimationFrame(loop);
}

/* ------------ старт ------------ */
async function start(){
  try{
    let stream;
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},audio:false});
    }catch(e){
      if(e && (e.name==='AbortError'||/aborted/i.test(e.message||''))){ await new Promise(r=>setTimeout(r,300)); stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); }
      else throw e;
    }
    video.setAttribute('playsinline',''); video.setAttribute('muted',''); video.muted=true;
    video.srcObject=stream;
    try{ await video.play(); }catch(_){ await new Promise(r=>setTimeout(r,120)); await video.play(); }

    resize(); buildSprites(); spawnFlakes();
    running=true;

    brand.style.display='block';
    controls.style.display='flex';
    mascot.style.display = mascotEnabled ? 'block' : 'none';

    if(startBtn) startBtn.remove();
    lastT=performance.now();
    requestAnimationFrame(loop);
    if(musicEnabled) startMusic();

    // автопроезд плуга: первый через 2с, затем — каждые 20с
    scheduleNextPlow(2000);
  }catch(e){
    alert('Не удалось открыть камеру: '+e.message);
  }
}
startBtn.addEventListener('click', start);

/* ------------ тумблеры ------------ */
function updateTogglesUI(){
  btnSnow.classList.toggle('is-on',snowEnabled);  btnSnow.setAttribute('aria-pressed',String(snowEnabled));
  btnMascot.classList.toggle('is-on',mascotEnabled); btnMascot.setAttribute('aria-pressed',String(mascotEnabled));
  btnMusic.classList.toggle('is-on',musicEnabled);  btnMusic.setAttribute('aria-pressed',String(musicEnabled));
  btnPlow.classList.add('is-on');                   btnPlow.setAttribute('aria-pressed','true'); // авто включён всегда
  mascot.style.display = running && mascotEnabled ? 'block' : 'none';
  if(navigator.vibrate) navigator.vibrate(8);
}
btnSnow.addEventListener('click',()=>{ snowEnabled=!snowEnabled; updateTogglesUI(); });
btnMascot.addEventListener('click',()=>{ mascotEnabled=!mascotEnabled; updateTogglesUI(); });
btnMusic.addEventListener('click',async()=>{ musicEnabled=!musicEnabled; updateTogglesUI(); if(musicEnabled) await startMusic(); else stopMusic(); });
btnPlow.addEventListener('click',()=>{ startPlowPass(); }); // нажал — плуг поехал сразу

/* ------------ фото ------------ */
shotBtn.addEventListener('click', async ()=>{
  flash.classList.add('go'); setTimeout(()=>flash.classList.remove('go'),60);

  const W=canvas.clientWidth,H=canvas.clientHeight;
  const shot=document.createElement('canvas');
  shot.width=Math.floor(W*CAPTURE_DPR); shot.height=Math.floor(H*CAPTURE_DPR);
  const sctx=shot.getContext('2d'); sctx.setTransform(CAPTURE_DPR,0,0,CAPTURE_DPR,0,0);

  // порядок слоёв как в live
  renderVideo(sctx);
  drawDrifts(sctx);
  drawPlow(sctx, performance.now());
  drawSpray(sctx);
  drawFlakes(sctx);

  if(mascotEnabled && mascotImg.complete){
    const rC=canvas.getBoundingClientRect(), rM=mascot.getBoundingClientRect();
    const mx=(rM.left-rC.left), my=(rM.top-rC.top), mw=rM.width, mh=rM.height;
    try{ sctx.drawImage(mascotImg,mx,my,mw,mh);}catch(_){}
  }

  const save=(blob)=>{
    const p=n=>String(n).padStart(2,'0'); const ts=new Date();
    const fname=`christmas-spb_${ts.getFullYear()}-${p(ts.getMonth()+1)}-${p(ts.getDate())}_${p(ts.getHours())}-${p(ts.getMinutes())}-${p(ts.getSeconds())}.png`;
    const file=new File([blob],fname,{type:'image/png'});
    const share={files:[file],title:'christmas-spb.ru',text:'christmas-spb.ru'};
    if(navigator.canShare && navigator.canShare(share)){ navigator.share(share).catch(()=>openInNewTabAsImage(blob)); return; }
    if(!/iphone|ipad|ipod/i.test(navigator.userAgent)){
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000); return;
    }
    openInNewTabAsImage(blob);
  };
  if(shot.toBlob) shot.toBlob(save,'image/png',0.92);
});

/* iOS вкладка с фото */
function openInNewTabAsImage(blob){
  const r=new FileReader();
  r.onload=()=>{
    const w=window.open('','_blank');
    const html=`<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<style>html,body{height:100%;margin:0;background:#000}.wrap{height:100%;display:flex;align-items:center;justify-content:center}img{max-width:100vw;max-height:100vh;display:block}</style>
<div class="wrap"><img src="${r.result}" alt="photo"></div>
<div class="hint" style="position:fixed;bottom:12px;left:50%;transform:translateX(-50%);color:#fff;font:14px system-ui;opacity:.8;text-shadow:0 1px 2px rgba(0,0,0,.6)">На iPhone: «Поделиться» → «Сохранить изображение»</div>`;
    if(w&&w.document){w.document.open();w.document.write(html);w.document.close();}
    else{document.open();document.write(html);document.close();}
  };
  r.readAsDataURL(blob);
}

/* перетаскивание/пинч маскота */
const pointers=new Map(); let dragId=null, dragStartX=0, dragStartY=0, startTx=0, startTy=0, startScale=1, startDist=0;
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function getTransform(){ const st=getComputedStyle(mascot); return {tx:parseFloat(st.getPropertyValue('--tx'))||0,ty:parseFloat(st.getPropertyValue('--ty'))||0,s:parseFloat(st.getPropertyValue('--s'))||1}; }
function setTransform(tx,ty,s){ mascot.style.setProperty('--tx',tx+'px'); mascot.style.setProperty('--ty',ty+'px'); mascot.style.setProperty('--s',s); }

mascot.addEventListener('pointerdown',e=>{
  if(!running || mascot.style.display==='none') return;
  e.preventDefault(); mascot.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  const n=pointers.size; const {tx,ty,s}=getTransform();
  if(n===1){ dragId=e.pointerId; dragStartX=e.clientX; dragStartY=e.clientY; startTx=tx; startTy=ty; mascot.classList.add('dragging'); }
  else if(n===2){ startScale=s; const [p1,p2]=Array.from(pointers.values()); startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1; mascot.classList.remove('dragging'); dragId=null; }
},{passive:false});
mascot.addEventListener('pointermove',e=>{
  if(!pointers.has(e.pointerId)) return;
  e.preventDefault(); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  const n=pointers.size; const {tx,ty,s}=getTransform();
  if(n===1 && dragId!==null){
    const cur=pointers.get(dragId); const dx=cur.x-dragStartX; const dy=cur.y-dragStartY;
    setTransform(startTx+dx,startTy+dy,s);
  }else if(n===2){
    const [p1,p2]=Array.from(pointers.values()); const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1;
    const scale=clamp(startScale*(dist/startDist),0.2,5); setTransform(tx,ty,scale);
  }
},{passive:false});
function endPointer(e){
  if(pointers.has(e.pointerId)) pointers.delete(e.pointerId);
  if(e.pointerId===dragId){ dragId=null; mascot.classList.remove('dragging'); }
  if(pointers.size===1){
    const id=Array.from(pointers.keys())[0], pt=pointers.get(id), {tx,ty}=getTransform();
    dragId=id; dragStartX=pt.x; dragStartY=pt.y; startTx=tx; startTy=ty; mascot.classList.add('dragging');
  }
}
mascot.addEventListener('pointerup',endPointer,{passive:false});
mascot.addEventListener('pointercancel',endPointer,{passive:false});
mascot.addEventListener('pointerleave',endPointer,{passive:false});
</script>
</body>
</html>
