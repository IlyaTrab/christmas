<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Snow Cam</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Snow Cam">
  <meta name="theme-color" content="#000000">
  <style>
    html,body {margin:0;height:100%;background:#000;overflow:hidden;}
    #wrap {position:fixed;inset:0;}
    video,canvas {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
    #start {position:fixed;inset:auto 1rem 2rem 1rem; padding:1rem 1.25rem;
            font-size:1.1rem;border-radius:.75rem;border:0;background:#fff;}
    #hint {position:fixed;top:1rem;left:1rem;color:#fff;font:14px system-ui, sans-serif;
           text-shadow:0 1px 2px #000;opacity:.8}

    /* GIF-снеговик: можно двигать и масштабировать */
    #mascot {
      position: absolute;
      left: 1rem;
      bottom: 5.5rem;          /* не перекрывать кнопку "Старт" */
      width: 28%;
      max-width: 320px;
      z-index: 5;              /* выше canvas/video */
      display: none;           /* покажем после старта */
      /* жесты */
      touch-action: none;      /* даём свой drag+pinch, блокируем зум/скролл браузера */
      user-select: none;
      cursor: grab;
      /* управляем трансформацией через CSS-переменные */
      --tx: 0px;               /* смещение по X */
      --ty: 0px;               /* смещение по Y (вниз — +) */
      --s: 1;                  /* масштаб */
      transform: translate(var(--tx), var(--ty)) scale(var(--s));
      transform-origin: center center;
    }
    #mascot.dragging { cursor: grabbing; }

    #mascot img {
      display: block;
      width: 100%;
      height: auto;
      pointer-events: none;    /* чтобы внутренняя картинка не перехватывала тапы */
    }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <!-- Снеговик (GIF). Убедись, что файл лежит по пути assets/snowman.gif -->
    <div id="mascot">
      <img src="assets/snowman.gif" alt="Снеговик" draggable="false">
    </div>
  </div>

  <button id="start">Запустить камеру</button>
  <div id="hint">Подай доступ к камере — и пойдёт снег ❄️ (перетаскивай и щипком масштабируй снеговика)</div>

  <script>
    const startBtn = document.getElementById('start');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const mascot = document.getElementById('mascot');
    const ctx = canvas.getContext('2d', { alpha: true });
    let flakes = [], running = false;

    function resize() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.width  = Math.floor(canvas.clientWidth  * dpr);
      canvas.height = Math.floor(canvas.clientHeight * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resize);

    function initSnow() {
      const count = Math.floor((canvas.clientWidth * canvas.clientHeight) / 12000);
      flakes = new Array(count).fill(0).map(() => ({
        x: Math.random() * canvas.clientWidth,
        y: Math.random() * canvas.clientHeight,
        r: 1 + Math.random() * 3,
        vx: -0.5 + Math.random(),
        vy: 1 + Math.random() * 2
      }));
    }

    function draw() {
      if (!running) return;
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      // Рисуем кадр камеры
      try { ctx.drawImage(video, 0, 0, canvas.clientWidth, canvas.clientHeight); } catch(e) {}

      // Полупрозрачная вуаль для «мороза»
      ctx.fillStyle = 'rgba(255,255,255,0.04)';
      ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);

      // Снег
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      for (const f of flakes) {
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fill();
        f.x += f.vx; f.y += f.vy;
        if (f.y > canvas.clientHeight + 5) { f.y = -5; f.x = Math.random()*canvas.clientWidth; }
        if (f.x > canvas.clientWidth + 5) f.x = -5;
        if (f.x < -5) f.x = canvas.clientWidth + 5;
      }
      requestAnimationFrame(draw);
    }

    async function start() {
      try {
        // Задняя камера, понижаем разрешение ради FPS
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        resize(); initSnow();
        running = true; startBtn.remove();

        // Показать GIF-снеговика после старта камеры
        mascot.style.display = 'block';

        requestAnimationFrame(draw);
      } catch (e) {
        alert('Не удалось открыть камеру: ' + e.message);
      }
    }
    startBtn.addEventListener('click', start);

    /* ========= ДВИЖЕНИЕ И МАСШТАБ СНЕГОВИКА (Pointer Events) ========= */
    const pointers = new Map();
    let dragId = null, dragStartX = 0, dragStartY = 0;
    let startTx = 0, startTy = 0, startScale = 1, startDist = 0;

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function getTransform() {
      const st = getComputedStyle(mascot);
      return {
        tx: parseFloat(st.getPropertyValue('--tx')) || 0,
        ty: parseFloat(st.getPropertyValue('--ty')) || 0,
        s:  parseFloat(st.getPropertyValue('--s'))  || 1
      };
    }
    function setTransform(tx, ty, s) {
      mascot.style.setProperty('--tx', tx + 'px');
      mascot.style.setProperty('--ty', ty + 'px');
      mascot.style.setProperty('--s',  s);
    }

    mascot.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      mascot.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});
      const n = pointers.size;
      const {tx, ty, s} = getTransform();

      if (n === 1) {
        dragId = e.pointerId;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        startTx = tx; startTy = ty;
        mascot.classList.add('dragging');
      } else if (n === 2) {
        // старт pinch
        startScale = s;
        const [p1, p2] = Array.from(pointers.values());
        startDist = Math.hypot(p2.x - p1.x, p2.y - p1.y) || 1;
        mascot.classList.remove('dragging');
        dragId = null;
      }
    }, {passive:false});

    mascot.addEventListener('pointermove', (e) => {
      if (!pointers.has(e.pointerId)) return;
      e.preventDefault();
      pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});

      const n = pointers.size;
      const {tx, ty, s} = getTransform();

      if (n === 1 && dragId !== null) {
        // перетаскивание
        const cur = pointers.get(dragId);
        const dx = cur.x - dragStartX;
        const dy = cur.y - dragStartY;
        setTransform(startTx + dx, startTy + dy, s);
      } else if (n === 2) {
        // pinch-zoom (масштаб вокруг центра снеговика)
        const [p1, p2] = Array.from(pointers.values());
        const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y) || 1;
        const scale = clamp(startScale * (dist / startDist), 0.3, 3);
        setTransform(tx, ty, scale);
      }
    }, {passive:false});

    function endPointer(e) {
      if (pointers.has(e.pointerId)) {
        pointers.delete(e.pointerId);
      }
      if (e.pointerId === dragId) {
        dragId = null;
        mascot.classList.remove('dragging');
      }
      // если после pinch остался один палец — подготовим его как «новое» перетаскивание
      if (pointers.size === 1) {
        const id = Array.from(pointers.keys())[0];
        const pt = pointers.get(id);
        const {tx, ty} = getTransform();
        dragId = id;
        dragStartX = pt.x;
        dragStartY = pt.y;
        startTx = tx; startTy = ty;
        mascot.classList.add('dragging');
      }
    }
    mascot.addEventListener('pointerup', endPointer, {passive:false});
    mascot.addEventListener('pointercancel', endPointer, {passive:false});
    mascot.addEventListener('pointerleave', endPointer, {passive:false});
  </script>
</body>
</html>
