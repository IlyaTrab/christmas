<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Snow Cam</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Snow Cam">
  <meta name="theme-color" content="#000000">

  <!-- –ö—Ä–∞—Å–∏–≤—ã–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —à—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">

  <style>
    html,body {margin:0;height:100%;background:#000;overflow:hidden;}
    #wrap {position:fixed;inset:0;}
    video,canvas {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}

    #start, #shotBtn {
      position:fixed; left:1rem; right:1rem;
      padding:1rem 1.25rem; font-size:1.1rem;
      border-radius:.75rem; border:0; background:#fff;
    }
    #start { bottom:2rem; }
    #shotBtn { bottom:5.7rem; display:none; } /* –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ */

    #hint {position:fixed;top:1rem;left:1rem;color:#fff;font:14px system-ui, sans-serif;
           text-shadow:0 1px 2px #000;opacity:.8;z-index:6}

    /* GIF-—Å–Ω–µ–≥–æ–≤–∏–∫: –º–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å */
    #mascot {
      position: absolute;
      left: 1rem;
      bottom: 5.5rem;
      width: 28%;
      max-width: 320px;
      z-index: 5;
      display: none;
      touch-action: none;
      user-select: none;
      cursor: grab;
      --tx: 0px; --ty: 0px; --s: 1;
      transform: translate(var(--tx), var(--ty)) scale(var(--s));
      transform-origin: center center;
    }
    #mascot.dragging { cursor: grabbing; }
    #mascot img { display:block; width:100%; height:auto; pointer-events:none; }
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <!-- –°–Ω–µ–≥–æ–≤–∏–∫ (GIF). –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –ø–æ –ø—É—Ç–∏ assets/snowman.gif -->
    <div id="mascot">
      <img id="mascotImg" src="assets/snowman.gif" alt="–°–Ω–µ–≥–æ–≤–∏–∫" draggable="false">
    </div>
  </div>

  <button id="shotBtn">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
  <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
  <div id="hint">–ü–æ–¥–∞–π –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ ‚Äî –∫—Ä—É–ø–Ω—ã–µ ¬´–ø—É—à–∏—Å—Ç—ã–µ¬ª —Å–Ω–µ–∂–∏–Ω–∫–∏ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π —Å–Ω–µ–≥–æ–≤–∏–∫. –©–∏–ø–∫–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä—É–π.</div>

  <script>
    const startBtn = document.getElementById('start');
    const shotBtn  = document.getElementById('shotBtn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const mascot = document.getElementById('mascot');
    const mascotImg = document.getElementById('mascotImg');
    const ctx = canvas.getContext('2d', { alpha: true });

    let flakes = [], running = false, sprites = [];
    let titleFontReady = false;

    /* ---------- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ¬´–ø—É—Ö–ª—ã—Ö¬ª —Å–Ω–µ–∂–∏–Ω–æ–∫ –∫–∞–∫ —Å–ø—Ä–∞–π—Ç–æ–≤ ---------- */
    function makeFlakeSprite(size, softness=0.9, alpha=0.95) {
      const s = Math.max(8, size|0);
      const off = document.createElement('canvas');
      off.width = off.height = s;
      const c = off.getContext('2d');
      const g = c.createRadialGradient(s/2, s/2, s*0.1, s/2, s/2, s*0.5);
      g.addColorStop(0, `rgba(255,255,255,${alpha})`);
      g.addColorStop(softness, 'rgba(255,255,255,0.15)');
      g.addColorStop(1, 'rgba(255,255,255,0)');
      c.fillStyle = g;
      c.beginPath(); c.arc(s/2, s/2, s*0.5, 0, Math.PI*2); c.fill();
      return off;
    }

    function buildSprites() {
      sprites = [
        makeFlakeSprite(48, 0.85, 0.95),
        makeFlakeSprite(36, 0.9, 0.9),
        makeFlakeSprite(28, 0.92, 0.88)
      ];
    }

    function resize() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.width  = Math.floor(canvas.clientWidth  * dpr);
      canvas.height = Math.floor(canvas.clientHeight * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resize);

    function initSnow() {
      const area = canvas.clientWidth * canvas.clientHeight;
      const base = Math.max(60, Math.floor(area / 20000)); // –∫–æ–ª-–≤–æ –∫—Ä—É–ø–Ω—ã—Ö —Å–Ω–µ–∂–∏–Ω–æ–∫
      flakes = new Array(base).fill(0).map(() => ({
        x0: Math.random() * canvas.clientWidth,
        y: Math.random() * canvas.clientHeight,
        r: 14 + Math.random() * 26,       // –∫—Ä—É–ø–Ω—ã–µ
        vy: 0.6 + Math.random() * 1.2,    // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
        swayAmp: 12 + Math.random() * 18, // –∞–º–ø–ª–∏—Ç—É–¥–∞ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏—è
        theta: Math.random() * Math.PI*2, // —Ñ–∞–∑–∞
        swaySpeed: 0.01 + Math.random()*0.02,
        sprite: sprites[(Math.random()*sprites.length)|0]
      }));
    }

    function drawTitle() {
      const w = canvas.clientWidth;
      const pad = 12;
      const size = Math.max(22, Math.floor(w * 0.075)); // ~7.5% —à–∏—Ä–∏–Ω—ã
      ctx.save();
      // –®—Ä–∏—Ñ—Ç (–¥–æ–∂–¥—ë–º—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
      ctx.font = `700 ${size}px "Mountains of Christmas", cursive`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      // –ì—Ä–∞–¥–∏–µ–Ω—Ç –∏ –æ–±–≤–æ–¥–∫–∞
      const grad = ctx.createLinearGradient(0, 0, w, 0);
      grad.addColorStop(0, '#fff7d6');
      grad.addColorStop(0.5, '#ffecd1');
      grad.addColorStop(1, '#ffffff');

      ctx.shadowColor = 'rgba(0,0,0,0.45)';
      ctx.shadowBlur = 8;
      ctx.lineWidth = 4;
      ctx.strokeStyle = 'rgba(20,35,80,0.85)';
      ctx.fillStyle = grad;

      const txt = 'christmas-spb.ru';
      const x = w / 2;
      const y = pad;
      ctx.strokeText(txt, x, y);
      ctx.fillText(txt, x, y);
      ctx.restore();
    }

    function drawSnow(ctxTarget) {
      for (const f of flakes) {
        f.theta += f.swaySpeed;
        const x = f.x0 + Math.sin(f.theta) * f.swayAmp;
        f.y += f.vy;
        // –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ
        if (f.y - f.r > canvas.clientHeight + 10) {
          f.y = -f.r - Math.random()*50;
          f.x0 = Math.random()*canvas.clientWidth;
          f.theta = Math.random()*Math.PI*2;
        }
        const s = f.sprite;
        const size = f.r * 2;
        ctxTarget.drawImage(s, x - f.r, f.y - f.r, size, size);
      }
    }

    function renderFrame(targetCtx) {
      // –≤–∏–¥–µ–æ
      try { targetCtx.drawImage(video, 0, 0, canvas.clientWidth, canvas.clientHeight); } catch(e) {}
      // –ª—ë–≥–∫–∞—è "–º–æ—Ä–æ–∑–Ω–∞—è" –≤—É–∞–ª—å
      targetCtx.fillStyle = 'rgba(255,255,255,0.03)';
      targetCtx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      // —Å–Ω–µ–≥
      drawSnow(targetCtx);
      // —Ç–∏—Ç—É–ª
      drawTitle();
      // —Å–Ω–µ–≥–æ–≤–∏–∫ (–¥–æ—Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ DOM-–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
      const rC = canvas.getBoundingClientRect();
      const rM = mascot.getBoundingClientRect();
      const scale = canvas.width / rC.width; // —É—á—ë—Ç DPR
      const mx = (rM.left - rC.left) * scale;
      const my = (rM.top  - rC.top ) * scale;
      const mw = rM.width * scale;
      const mh = rM.height * scale;
      if (mascotImg.complete) {
        try { targetCtx.drawImage(mascotImg, mx, my, mw, mh); } catch(e) {}
      }
    }

    function draw() {
      if (!running) return;
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      renderFrame(ctx);
      requestAnimationFrame(draw);
    }

    async function start() {
      try {
        // –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–¥–ø–∏—Å—å –±—ã–ª–∞ –∫—Ä–∞—Å–∏–≤–æ–π —Å –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞
        try { await document.fonts.ready; } catch(e) {}
        titleFontReady = true;

        // –∫–∞–º–µ—Ä–∞
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();

        resize(); buildSprites(); initSnow();
        running = true;
        startBtn.remove();
        shotBtn.style.display = 'block';
        mascot.style.display = 'block';

        requestAnimationFrame(draw);
      } catch (e) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: ' + e.message);
      }
    }
    startBtn.addEventListener('click', start);

    /* ---------- –°–Ω–∏–º–æ–∫ –∫–∞–¥—Ä–∞ (PNG) ---------- */
    shotBtn.addEventListener('click', () => {
      // –æ—Ç–¥–µ–ª—å–Ω—ã–π canvas –¥–ª—è —Å–Ω–∏–º–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö
      const shot = document.createElement('canvas');
      shot.width  = canvas.width;
      shot.height = canvas.height;
      const sctx = shot.getContext('2d');
      // –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ü–µ–Ω—É
      renderFrame(sctx);

      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª
      const url = shot.toDataURL('image/png');
      const a = document.createElement('a');
      const ts = new Date();
      const pad = n => String(n).padStart(2,'0');
      const fname = `christmas-spb_${ts.getFullYear()}-${pad(ts.getMonth()+1)}-${pad(ts.getDate())}_${pad(ts.getHours())}-${pad(ts.getMinutes())}-${pad(ts.getSeconds())}.png`;
      a.href = url; a.download = fname;
      // –ù–∞ iOS –ª—É—á—à–µ –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏–∑ –®–∞—Ä–∞
      if (/iphone|ipad|ipod/i.test(navigator.userAgent)) {
        window.open(url, '_blank');
      } else {
        a.click();
      }
    });

    /* ========= –î–í–ò–ñ–ï–ù–ò–ï –ò –ú–ê–°–®–¢–ê–ë –°–ù–ï–ì–û–í–ò–ö–ê (Pointer Events) ========= */
    const pointers = new Map();
    let dragId = null, dragStartX = 0, dragStartY = 0;
    let startTx = 0, startTy = 0, startScale = 1, startDist = 0;

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function getTransform() {
      const st = getComputedStyle(mascot);
      return {
        tx: parseFloat(st.getPropertyValue('--tx')) || 0,
        ty: parseFloat(st.getPropertyValue('--ty')) || 0,
        s:  parseFloat(st.getPropertyValue('--s'))  || 1
      };
    }
    function setTransform(tx, ty, s) {
      mascot.style.setProperty('--tx', tx + 'px');
      mascot.style.setProperty('--ty', ty + 'px');
      mascot.style.setProperty('--s',  s);
    }

    mascot.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      mascot.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});
      const n = pointers.size;
      const {tx, ty, s} = getTransform();

      if (n === 1) {
        dragId = e.pointerId;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        startTx = tx; startTy = ty;
        mascot.classList.add('dragging');
      } else if (n === 2) {
        startScale = s;
        const [p1, p2] = Array.from(pointers.values());
        startDist = Math.hypot(p2.x - p1.x, p2.y - p1.y) || 1;
        mascot.classList.remove('dragging');
        dragId = null;
      }
    }, {passive:false});

    mascot.addEventListener('pointermove', (e) => {
      if (!pointers.has(e.pointerId)) return;
      e.preventDefault();
      pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});

      const n = pointers.size;
      const {tx, ty, s} = getTransform();

      if (n === 1 && dragId !== null) {
        const cur = pointers.get(dragId);
        const dx = cur.x - dragStartX;
        const dy = cur.y - dragStartY;
        setTransform(startTx + dx, startTy + dy, s);
      } else if (n === 2) {
        const [p1, p2] = Array.from(pointers.values());
        const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y) || 1;
        const scale = clamp(startScale * (dist / startDist), 0.3, 3);
        setTransform(tx, ty, scale);
      }
    }, {passive:false});

    function endPointer(e) {
      if (pointers.has(e.pointerId)) pointers.delete(e.pointerId);
      if (e.pointerId === dragId) {
        dragId = null; mascot.classList.remove('dragging');
      }
      if (pointers.size === 1) {
        const id = Array.from(pointers.keys())[0];
        const pt = pointers.get(id);
        const {tx, ty} = getTransform();
        dragId = id; dragStartX = pt.x; dragStartY = pt.y;
        startTx = tx; startTy = ty; mascot.classList.add('dragging');
      }
    }
    mascot.addEventListener('pointerup', endPointer, {passive:false});
    mascot.addEventListener('pointercancel', endPointer, {passive:false});
    mascot.addEventListener('pointerleave', endPointer, {passive:false});
  </script>
</body>
</html>
