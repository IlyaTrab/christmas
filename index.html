<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Snow Cam</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Snow Cam">
  <meta name="theme-color" content="#000000">
  <style>
    html,body {margin:0;height:100%;background:#000;overflow:hidden;}
    #wrap {position:fixed;inset:0;}
    video,canvas {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}

    /* –ù–µ–±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞-—Å–Ω–∏–º–æ–∫ */
    #shotBtn{
      position:fixed; width:56px; height:56px; border-radius:50%;
      bottom:.9rem; right:.9rem; z-index:7;
      background:rgba(255,255,255,.95); border:0;
      font-size:24px; line-height:56px; text-align:center;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      display:none;
    }

    /* –õ–∞–∫–æ–Ω–∏—á–Ω—ã–π –±—Ä–µ–Ω–¥ —Å–≤–µ—Ä—Ö—É (—Ç–æ–ª—å–∫–æ –≤ live) */
    #brand{
      position:fixed; top:.8rem; left:50%; transform:translateX(-50%);
      font:600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff; letter-spacing:.5px; opacity:.9;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      z-index:6; user-select:none; pointer-events:none;
    }

    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã */
    #start{
      position:fixed; left:1rem; right:1rem; bottom:1.2rem; z-index:7;
      padding:.9rem 1.1rem; font:600 16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      border-radius:.75rem; border:0; background:#fff;
    }

    /* –°–Ω–µ–≥–æ–≤–∏–∫ (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ + pinch) */
    #mascot{
      position:absolute; left:1rem; bottom:4.8rem; z-index:5; display:none;
      width:24%; max-width:280px;
      touch-action:none; user-select:none; cursor:grab;
      --tx:0px; --ty:0px; --s:1;
      transform:translate(var(--tx),var(--ty)) scale(var(--s));
      transform-origin:center center;
    }
    #mascot.dragging{cursor:grabbing;}
    #mascot img{display:block; width:100%; height:auto; pointer-events:none;}
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <!-- –°–Ω–µ–≥–æ–≤–∏–∫ –∫–∞–∫ DOM-—Å–ª–æ–π (–≤ live, –Ω–µ —Ä–∏—Å—É–µ–º –µ–≥–æ –Ω–∞ canvas) -->
    <div id="mascot"><img id="mascotImg" src="assets/snowman.gif" alt="Snowman" draggable="false"></div>
  </div>

  <div id="brand">christmas-spb.ru</div>
  <button id="shotBtn" aria-label="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
  <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>

  <script>
    const startBtn  = document.getElementById('start');
    const shotBtn   = document.getElementById('shotBtn');
    const video     = document.getElementById('video');
    const canvas    = document.getElementById('canvas');
    const ctx       = canvas.getContext('2d', { alpha:true });
    const mascot    = document.getElementById('mascot');
    const mascotImg = document.getElementById('mascotImg');

    let running=false, flakes=[], sprites=[];

    /* ----- –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å–Ω–µ–∂–∏–Ω–∫–∏ ----- */
    function makeFlakeSprite(size){
      const s = Math.max(10, size|0);
      const off = document.createElement('canvas');
      off.width = off.height = s;
      const c = off.getContext('2d');
      const g = c.createRadialGradient(s/2, s/2, s*0.05, s/2, s/2, s*0.42);
      g.addColorStop(0.0, 'rgba(255,255,255,0.95)');
      g.addColorStop(0.6, 'rgba(255,255,255,0.35)');
      g.addColorStop(1.0, 'rgba(255,255,255,0.00)');
      c.fillStyle = g;
      c.beginPath(); c.arc(s/2, s/2, s*0.42, 0, Math.PI*2); c.fill();
      return off;
    }
    function buildSprites(){ sprites=[ makeFlakeSprite(16), makeFlakeSprite(14), makeFlakeSprite(12) ]; }

    function resize(){
      const dpr = Math.min(window.devicePixelRatio||1, 2);
      canvas.width  = Math.floor(canvas.clientWidth  * dpr);
      canvas.height = Math.floor(canvas.clientHeight * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resize);

    function initSnow(){
      const area = canvas.clientWidth * canvas.clientHeight;
      const n = Math.max(70, Math.floor(area/26000));
      flakes = new Array(n).fill(0).map(()=>({
        x0: Math.random()*canvas.clientWidth,
        y:  Math.random()*canvas.clientHeight,
        r:  6 + Math.random()*6,
        vy: 0.7 + Math.random()*1.0,
        swayAmp: 6 + Math.random()*10,
        theta: Math.random()*Math.PI*2,
        swaySpeed: 0.012 + Math.random()*0.018,
        sprite: sprites[(Math.random()*sprites.length)|0]
      }));
    }

    function drawSnow(targetCtx){
      for(const f of flakes){
        f.theta += f.swaySpeed;
        const x = f.x0 + Math.sin(f.theta)*f.swayAmp;
        f.y += f.vy;
        if(f.y - f.r > canvas.clientHeight + 8){
          f.y = -f.r - Math.random()*40;
          f.x0 = Math.random()*canvas.clientWidth;
          f.theta = Math.random()*Math.PI*2;
        }
        const s = f.sprite, size = f.r*2;
        targetCtx.drawImage(s, x - f.r, f.y - f.r, size, size);
      }
    }

    /* ---- –†–µ–Ω–¥–µ—Ä –∫–∞–¥—Ä–∞.
       live={includeMascot:false, includeBrand:false} ‚Äî –Ω–∞ —ç–∫—Ä–∞–Ω,
       shot={includeMascot:true, includeBrand:true} ‚Äî –¥–ª—è —Ñ–æ—Ç–æ */
    function renderFrame(targetCtx, {includeMascot=false, includeBrand=false}={}){
      try { targetCtx.drawImage(video, 0, 0, canvas.clientWidth, canvas.clientHeight); } catch(e){}
      targetCtx.fillStyle='rgba(255,255,255,0.015)';
      targetCtx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      drawSnow(targetCtx);

      if(includeBrand){
        const w = canvas.clientWidth;
        targetCtx.save();
        targetCtx.font='600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif';
        targetCtx.textAlign='center'; targetCtx.textBaseline='top';
        targetCtx.fillStyle='rgba(255,255,255,0.92)';
        targetCtx.shadowColor='rgba(0,0,0,0.45)'; targetCtx.shadowBlur=6;
        targetCtx.fillText('christmas-spb.ru', w/2, 10);
        targetCtx.restore();
      }

      if(includeMascot && mascotImg.complete){
        const rC = canvas.getBoundingClientRect();
        const rM = mascot.getBoundingClientRect();
        const scale = canvas.width / rC.width;
        const mx = (rM.left - rC.left) * scale;
        const my = (rM.top  - rC.top ) * scale;
        const mw = rM.width * scale;
        const mh = rM.height * scale;
        try { targetCtx.drawImage(mascotImg, mx, my, mw, mh); } catch(e){}
      }
    }

    function loop(){
      if(!running) return;
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      renderFrame(ctx, {includeMascot:false, includeBrand:false}); // LIVE: –±–µ–∑ –¥—É–±–ª–µ–π
      requestAnimationFrame(loop);
    }

    async function start(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}},
          audio:false
        });
        video.srcObject = stream;
        await video.play();

        resize(); buildSprites(); initSnow();
        running = true;
        startBtn.remove();
        shotBtn.style.display='block';
        mascot.style.display='block';
        requestAnimationFrame(loop);
      }catch(e){
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: '+e.message);
      }
    }
    startBtn.addEventListener('click', start);

    /* ---- –°–Ω–∏–º–æ–∫ (Share Sheet / download / –≤–∫–ª–∞–¥–∫–∞) ---- */
    shotBtn.addEventListener('click', () => {
      // 1) –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–∏–º–æ–∫
      const shot = document.createElement('canvas');
      shot.width = canvas.width; 
      shot.height = canvas.height;
      const sctx = shot.getContext('2d');
      renderFrame(sctx, { includeMascot: true, includeBrand: true });

      // 2) –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ Blob ‚Üí File –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è/—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
      const save = (blob) => {
        const p = (n)=>String(n).padStart(2,'0');
        const ts = new Date();
        const fname = `christmas-spb_${ts.getFullYear()}-${p(ts.getMonth()+1)}-${p(ts.getDate())}_${p(ts.getHours())}-${p(ts.getMinutes())}-${p(ts.getSeconds())}.png`;
        const file = new File([blob], fname, { type: 'image/png' });

        // Web Share API —Å —Ñ–∞–π–ª–∞–º–∏ (iOS 15+/Android 12+)
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file], title: 'christmas-spb.ru' })
            .catch(() => fallbackOpen(blob)); // –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–ª–∏ ‚Äî –æ—Ç–∫—Ä–æ–µ–º –≤–∫–ª–∞–¥–∫—É
          return;
        }
        // –û–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (Android/desktop)
        fallbackDownload(blob, fname);
      };

      if (shot.toBlob) {
        shot.toBlob(save, 'image/png', 0.92);
      } else {
        // –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã
        const url = shot.toDataURL('image/png');
        fallbackOpenDataURL(url);
      }
    });

    function fallbackDownload(blob, fname) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fname;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    function fallbackOpen(blob) {
      // iOS: –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Üí ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ¬ª
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if (!w) window.location.href = url;
      setTimeout(()=>URL.revokeObjectURL(url), 20000);
    }

    function fallbackOpenDataURL(url) {
      const w = window.open(url, '_blank');
      if (!w) window.location.href = url;
    }

    /* ---- –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ pinch –º–∞—Å—à—Ç–∞–± ---- */
    const pointers = new Map();
    let dragId=null, dragStartX=0, dragStartY=0, startTx=0, startTy=0, startScale=1, startDist=0;

    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
    function getTransform(){
      const st = getComputedStyle(mascot);
      return {
        tx: parseFloat(st.getPropertyValue('--tx'))||0,
        ty: parseFloat(st.getPropertyValue('--ty'))||0,
        s:  parseFloat(st.getPropertyValue('--s')) ||1
      };
    }
    function setTransform(tx,ty,s){
      mascot.style.setProperty('--tx', tx+'px');
      mascot.style.setProperty('--ty', ty+'px');
      mascot.style.setProperty('--s',  s);
    }

    mascot.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      mascot.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      const n = pointers.size;
      const {tx,ty,s}=getTransform();
      if(n===1){
        dragId=e.pointerId; dragStartX=e.clientX; dragStartY=e.clientY; startTx=tx; startTy=ty; mascot.classList.add('dragging');
      }else if(n===2){
        startScale=s; const [p1,p2]=Array.from(pointers.values()); startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1; mascot.classList.remove('dragging'); dragId=null;
      }
    },{passive:false});

    mascot.addEventListener('pointermove', (e)=>{
      if(!pointers.has(e.pointerId)) return;
      e.preventDefault();
      pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      const n=pointers.size; const {tx,ty,s}=getTransform();
      if(n===1 && dragId!==null){
        const cur=pointers.get(dragId); const dx=cur.x-dragStartX; const dy=cur.y-dragStartY; setTransform(startTx+dx,startTy+dy,s);
      }else if(n===2){
        const [p1,p2]=Array.from(pointers.values()); const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1;
        const scale=clamp(startScale*(dist/startDist), 0.2, 5);
        setTransform(tx,ty,scale);
      }
    },{passive:false});

    function endPointer(e){
      if(pointers.has(e.pointerId)) pointers.delete(e.pointerId);
      if(e.pointerId===dragId){ dragId=null; mascot.classList.remove('dragging'); }
      if(pointers.size===1){
        const id=Array.from(pointers.keys())[0], pt=pointers.get(id), {tx,ty}=getTransform();
        dragId=id; dragStartX=pt.x; dragStartY=pt.y; startTx=tx; startTy=ty; mascot.classList.add('dragging');
      }
    }
    mascot.addEventListener('pointerup', endPointer, {passive:false});
    mascot.addEventListener('pointercancel', endPointer, {passive:false});
    mascot.addEventListener('pointerleave', endPointer, {passive:false});
  </script>
</body>
</html>
