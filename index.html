<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Snow Cam</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Snow Cam">
  <meta name="theme-color" content="#000000">
  <style>
    html,body {margin:0;height:100%;background:#000;overflow:hidden;}
    #wrap {position:fixed;inset:0;}
    video,canvas {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}

    /* –º–∞–ª–µ–Ω—å–∫–∞—è –∫–Ω–æ–ø–∫–∞-—Å–Ω–∏–º–æ–∫ */
    #shotBtn{
      position:fixed; width:56px; height:56px; border-radius:50%;
      bottom:.9rem; right:.9rem; z-index:7;
      background:rgba(255,255,255,.95); border:0;
      font-size:24px; line-height:56px; text-align:center;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      display:none;
    }

    /* –±—Ä–µ–Ω–¥ —Å–≤–µ—Ä—Ö—É (—Ç–æ–ª—å–∫–æ –≤ live-—Å–ª–æ–µ) */
    #brand{
      position:fixed; top:.8rem; left:50%; transform:translateX(-50%);
      font:600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff; letter-spacing:.5px; opacity:.9;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      z-index:6; user-select:none; pointer-events:none;
    }

    /* –∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã */
    #start{
      position:fixed; left:1rem; right:1rem; bottom:1.2rem; z-index:7;
      padding:.9rem 1.1rem; font:600 16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      border-radius:.75rem; border:0; background:#fff;
    }

    /* —Å–Ω–µ–≥–æ–≤–∏–∫ (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ + pinch) */
    #mascot{
      position:absolute; left:1rem; bottom:4.8rem; z-index:5; display:none;
      width:24%; max-width:280px;
      touch-action:none; user-select:none; cursor:grab;
      --tx:0px; --ty:0px; --s:1;
      transform:translate(var(--tx),var(--ty)) scale(var(--s));
      transform-origin:center center;
    }
    #mascot.dragging{cursor:grabbing;}
    #mascot img{display:block; width:100%; height:auto; pointer-events:none;}
  </style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <!-- —Å–Ω–µ–≥–æ–≤–∏–∫ –∫–∞–∫ DOM-—Å–ª–æ–π -->
    <div id="mascot"><img id="mascotImg" src="assets/snowman.gif" alt="Snowman" draggable="false"></div>
  </div>

  <div id="brand">christmas-spb.ru</div>
  <button id="shotBtn" aria-label="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
  <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>

  <script>
    const startBtn  = document.getElementById('start');
    const shotBtn   = document.getElementById('shotBtn');
    const video     = document.getElementById('video');
    const canvas    = document.getElementById('canvas');
    const ctx       = canvas.getContext('2d', { alpha:true });
    const mascot    = document.getElementById('mascot');
    const mascotImg = document.getElementById('mascotImg');

    // ---- –í—ã–≤–æ–¥ –≤ live: —Ä–∞–±–æ—Ç–∞–µ–º –≤ CSS-–ø–∏–∫—Å–µ–ª—è—Ö, –Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤ HiDPI
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
    // ---- –°–Ω–∏–º–æ–∫: –º–∞—Å—à—Ç–∞–± (1 = –∫–∞–∫ —ç–∫—Ä–∞–Ω, 2 = –≤–¥–≤–æ–µ —á—ë—Ç—á–µ; –º–æ–∂–Ω–æ 3, –Ω–æ —Ñ–∞–π–ª—ã —Ä–∞—Å—Ç—É—Ç)
    const CAPTURE_DPR = DPR; // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞–≤—å 1, 1.5, 2, 3

    let running=false, flakes=[], sprites=[];

    /* ---- —Å–Ω–µ–∂–∏–Ω–∫–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ) ---- */
    function makeFlakeSprite(size){
      const s = Math.max(10, size|0);
      const off = document.createElement('canvas');
      off.width = off.height = s;
      const c = off.getContext('2d');
      const g = c.createRadialGradient(s/2, s/2, s*0.05, s/2, s/2, s*0.42);
      g.addColorStop(0.0, 'rgba(255,255,255,0.95)');
      g.addColorStop(0.6, 'rgba(255,255,255,0.35)');
      g.addColorStop(1.0, 'rgba(255,255,255,0.00)');
      c.fillStyle = g;
      c.beginPath(); c.arc(s/2, s/2, s*0.42, 0, Math.PI*2); c.fill();
      return off;
    }
    function buildSprites(){ sprites=[ makeFlakeSprite(16), makeFlakeSprite(14), makeFlakeSprite(12) ]; }

    function resize(){
      // –¥–µ–ª–∞–µ–º —Ö–æ–ª—Å—Ç HiDPI, –Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Äî –≤ CSS-–ø–∏–∫—Å–µ–ª—è—Ö
      canvas.width  = Math.floor(canvas.clientWidth  * DPR);
      canvas.height = Math.floor(canvas.clientHeight * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    window.addEventListener('resize', resize);

    function initSnow(){
      const area = canvas.clientWidth * canvas.clientHeight;
      const n = Math.max(70, Math.floor(area/26000));
      flakes = new Array(n).fill(0).map(()=>({
        x0: Math.random()*canvas.clientWidth,
        y:  Math.random()*canvas.clientHeight,
        r:  6 + Math.random()*6,
        vy: 0.7 + Math.random()*1.0,
        swayAmp: 6 + Math.random()*10,
        theta: Math.random()*Math.PI*2,
        swaySpeed: 0.012 + Math.random()*0.018,
        sprite: sprites[(Math.random()*sprites.length)|0]
      }));
    }

    function drawSnow(targetCtx){
      for(const f of flakes){
        f.theta += f.swaySpeed;
        const x = f.x0 + Math.sin(f.theta)*f.swayAmp;
        f.y += f.vy;
        if(f.y - f.r > canvas.clientHeight + 8){
          f.y = -f.r - Math.random()*40;
          f.x0 = Math.random()*canvas.clientWidth;
          f.theta = Math.random()*Math.PI*2;
        }
        const s = f.sprite, size = f.r*2;
        targetCtx.drawImage(s, x - f.r, f.y - f.r, size, size);
      }
    }

    /* ---- –æ–±—â–∏–π —Ä–µ–Ω–¥–µ—Ä –∫–∞–¥—Ä–∞ (–æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ targetCtx —É–∂–µ –≤ CSS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö) ---- */
    function renderFrame(targetCtx, {includeMascot=false, includeBrand=false}={}){
      const W = canvas.clientWidth, H = canvas.clientHeight;

      try { targetCtx.drawImage(video, 0, 0, W, H); } catch(e){}
      targetCtx.fillStyle='rgba(255,255,255,0.015)';
      targetCtx.fillRect(0,0,W,H);
      drawSnow(targetCtx);

      if(includeBrand){
        targetCtx.save();
        targetCtx.font='600 18px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif';
        targetCtx.textAlign='center'; targetCtx.textBaseline='top';
        targetCtx.fillStyle='rgba(255,255,255,0.92)';
        targetCtx.shadowColor='rgba(0,0,0,0.45)'; targetCtx.shadowBlur=6;
        targetCtx.fillText('christmas-spb.ru', W/2, 10);
        targetCtx.restore();
      }

      if(includeMascot && mascotImg.complete){
        const rC = canvas.getBoundingClientRect();
        const rM = mascot.getBoundingClientRect();
        // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ CSS-–ø–∏–∫—Å–µ–ª—è—Ö ‚Äî –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞!
        const mx = (rM.left - rC.left);
        const my = (rM.top  - rC.top );
        const mw = rM.width;
        const mh = rM.height;
        try { targetCtx.drawImage(mascotImg, mx, my, mw, mh); } catch(e){}
      }
    }

    function loop(){
      if(!running) return;
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      renderFrame(ctx, {includeMascot:false, includeBrand:false});
      requestAnimationFrame(loop);
    }

    async function start(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}},
          audio:false
        });
        video.srcObject = stream;
        await video.play();

        resize(); buildSprites(); initSnow();
        running = true;
        startBtn.remove();
        shotBtn.style.display='block';
        mascot.style.display='block';
        requestAnimationFrame(loop);
      }catch(e){
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: '+e.message);
      }
    }
    startBtn.addEventListener('click', start);

    /* ---- –°–Ω–∏–º–æ–∫: Share Sheet / download / –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ —Å <img> ---- */
    shotBtn.addEventListener('click', () => {
      // —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ö–æ–ª—Å—Ç –ø–æ–¥ —Å–Ω–∏–º–æ–∫ –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
      const shot = document.createElement('canvas');
      const Wcss = canvas.clientWidth, Hcss = canvas.clientHeight;
      shot.width  = Math.floor(Wcss * CAPTURE_DPR);
      shot.height = Math.floor(Hcss * CAPTURE_DPR);
      const sctx = shot.getContext('2d');
      // —Ä–∞–±–æ—Ç–∞–µ–º –≤ CSS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö, –∫–∞–∫ –∏ –≤ live
      sctx.setTransform(CAPTURE_DPR,0,0,CAPTURE_DPR,0,0);

      renderFrame(sctx, { includeMascot: true, includeBrand: true });

      const save = (blob) => {
        const p = n => String(n).padStart(2,'0');
        const ts = new Date();
        const fname = `christmas-spb_${ts.getFullYear()}-${p(ts.getMonth()+1)}-${p(ts.getDate())}_${p(ts.getHours())}-${p(ts.getMinutes())}-${p(ts.getSeconds())}.png`;
        const file = new File([blob], fname, { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file], title: 'christmas-spb.ru' })
            .catch(() => openInNewTabAsImage(blob));
          return;
        }
        if (!/iphone|ipad|ipod/i.test(navigator.userAgent)) {
          downloadBlob(blob, fname);
          return;
        }
        openInNewTabAsImage(blob);
      };

      if (shot.toBlob) shot.toBlob(save, 'image/png', 0.92);
      else openDataURLInNewTab(shot.toDataURL('image/png'));
    });

    function downloadBlob(blob, fname) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fname;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    function openInNewTabAsImage(blob) {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const w = window.open('', '_blank');
        const html = `
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Photo</title>
<style>
  html,body{height:100%;margin:0;background:#000;}
  .wrap{height:100%;display:flex;align-items:center;justify-content:center;}
  img{max-width:100vw;max-height:100vh;display:block}
  .hint{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
        color:#fff;font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        opacity:.8;text-shadow:0 1px 2px rgba(0,0,0,.6);}
</style></head>
<body>
  <div class="wrap"><img src="${dataUrl}" alt="photo"></div>
  <div class="hint">–ù–∞ iPhone: ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ¬ª</div>
</body></html>`;
        if (w && w.document) { w.document.open(); w.document.write(html); w.document.close(); }
        else { document.open(); document.write(html); document.close(); }
      };
      reader.readAsDataURL(blob);
    }

    function openDataURLInNewTab(url) {
      const w = window.open('', '_blank');
      const html = `<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>html,body{height:100%;margin:0;background:#000}.wrap{height:100%;display:flex;align-items:center;justify-content:center}img{max-width:100vw;max-height:100vh;display:block}</style><div class="wrap"><img src="${url}" alt="photo"></div>`;
      if (w && w.document) { w.document.open(); w.document.write(html); w.document.close(); }
      else { document.write(html); }
    }

    /* ---- –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ pinch –º–∞—Å—à—Ç–∞–± ---- */
    const pointers = new Map();
    let dragId=null, dragStartX=0, dragStartY=0, startTx=0, startTy=0, startScale=1, startDist=0;

    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
    function getTransform(){
      const st = getComputedStyle(mascot);
      return {
        tx: parseFloat(st.getPropertyValue('--tx'))||0,
        ty: parseFloat(st.getPropertyValue('--ty'))||0,
        s:  parseFloat(st.getPropertyValue('--s')) ||1
      };
    }
    function setTransform(tx,ty,s){
      mascot.style.setProperty('--tx', tx+'px');
      mascot.style.setProperty('--ty', ty+'px');
      mascot.style.setProperty('--s',  s);
    }

    mascot.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      mascot.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      const n = pointers.size;
      const {tx,ty,s}=getTransform();
      if(n===1){
        dragId=e.pointerId; dragStartX=e.clientX; dragStartY=e.clientY; startTx=tx; startTy=ty; mascot.classList.add('dragging');
      }else if(n===2){
        startScale=s; const [p1,p2]=Array.from(pointers.values()); startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1; mascot.classList.remove('dragging'); dragId=null;
      }
    },{passive:false});

    mascot.addEventListener('pointermove', (e)=>{
      if(!pointers.has(e.pointerId)) return;
      e.preventDefault();
      pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
      const n=pointers.size; const {tx,ty,s}=getTransform();
      if(n===1 && dragId!==null){
        const cur=pointers.get(dragId); const dx=cur.x-dragStartX; const dy=cur.y-dragStartY; setTransform(startTx+dx,startTy+dy,s);
      }else if(n===2){
        const [p1,p2]=Array.from(pointers.values()); const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y)||1;
        const scale=clamp(startScale*(dist/startDist), 0.2, 5);
        setTransform(tx,ty,scale);
      }
    },{passive:false});

    function endPointer(e){
      if(pointers.has(e.pointerId)) pointers.delete(e.pointerId);
      if(e.pointerId===dragId){ dragId=null; mascot.classList.remove('dragging'); }
      if(pointers.size===1){
        const id=Array.from(pointers.keys())[0], pt=pointers.get(id), {tx,ty}=getTransform();
        dragId=id; dragStartX=pt.x; dragStartY=pt.y; startTx=tx; startTy=ty; mascot.classList.add('dragging');
      }
    }
    mascot.addEventListener('pointerup', endPointer, {passive:false});
    mascot.addEventListener('pointercancel', endPointer, {passive:false});
    mascot.addEventListener('pointerleave', endPointer, {passive:false});
  </script>
</body>
</html>
